import { j as e, r as k, t as u } from "./react-D9TtqY-V.js";
import { f as z, i as g } from "./@tanstack-3iyDWv8L.js";
import { a as G, S as R, C as U, m as D } from "./db-master-BrZHBPj2.js";
import { B as n } from "./button-CMoAlsw3.js";
import { B as x } from "./badge-B6qKYUZD.js";
import { C as c, a as d, b as o, c as f, d as m } from "./card-85OZoUtz.js";
import { q as W, ag as H, N as J, i as V, U as q, s as Q, x as _, D as I, ab as K, ad as X, d as Y, m as Z } from "./icons-bBaH0MBC.js";
import { T as ee, a as se, b as T, c as A } from "./tabs-D5XuT8p1.js";
import { D as ae, a as te, b as re, e as j, S as le } from "./SessionSetupWizard-CsDv7O_p.js";
import { n as ie } from "./id-OxPLOBIU.js";
import { A as ne, a as ce, b as de, c as oe, d as me, e as xe, f as he, g as pe, h as ue } from "./alert-dialog-Bxna6sSR.js";
import { c as ge } from "./index-IzUhM_kF.js";
import "./vendor-C4ToNUTj.js";
import "./@radix-ui-BQCqNqg0.js";
import "./immer-BCQU3qJI.js";
import "./dexie-C2pyTzVO.js";
import "./zod-fbN9ubnj.js";
import "./components-and-styling-lnR2ABT4.js";
import "./shadcn-utils-BMZD7_jZ.js";
import "./@tailwind-COJ8Fh6m.js";
import "./dialog-v6BqSj-g.js";
import "./llm-readiness-DgR8F2ee.js";
import "./input-CtGFdN_9.js";
import "./label-CBzbyhxK.js";
import "./textarea-NuAUq_bK.js";
const $ = (l) => {
  const [r, ...a] = l;
  if (["and", "or", "all", "any", "some"].includes(r)) {
    const t = a[0], p = r === "and" || r === "all" ? " \u4E14 " : " \u6216 ";
    return `(${t.map($).join(p)})`;
  }
  return r === "isTrue" || r === "isFalse" ? `${a[0]} \u4E3A ${r === "isTrue" ? "\u771F" : "\u5047"}` : `${a[0]} ${r} ${JSON.stringify(a[1])}`;
}, je = (l) => e.jsxs("div", { className: "space-y-6", children: [e.jsxs(c, { children: [e.jsxs(d, { children: [e.jsxs(o, { className: "text-lg flex items-center gap-2", children: [e.jsx(W, { className: "w-5 h-5 text-destructive" }), "\u6838\u5FC3\u4ECB\u7ECD"] }), e.jsx(f, { children: "\u6311\u6218\u80CC\u666F\u4E0E\u4E16\u754C\u89C2\u8BBE\u5B9A" })] }), e.jsx(m, { children: e.jsx("p", { className: "text-sm leading-relaxed text-muted-foreground whitespace-pre-wrap", children: l.challenge.description }) })] }), e.jsxs(c, { children: [e.jsxs(d, { children: [e.jsxs(o, { className: "text-lg flex items-center gap-2", children: [e.jsx(H, { className: "w-5 h-5 text-primary" }), "\u76EE\u6807\u6311\u6218 (Goals)"] }), e.jsx(f, { children: "\u5F53\u6240\u6709\u76EE\u6807\u8FBE\u6210\u65F6\uFF0C\u6311\u6218\u5373\u544A\u6210\u529F" })] }), e.jsx(m, { className: "space-y-4", children: l.challenge.goals.map((r, a) => e.jsxs("div", { className: "flex gap-4 p-4 rounded-lg bg-muted/40 border group hover:border-primary/50 transition-colors", children: [e.jsx("div", { className: "w-7 h-7 rounded-full bg-primary/10 text-primary flex items-center justify-center text-sm font-bold shrink-0", children: a + 1 }), e.jsxs("div", { className: "grow", children: [e.jsx("div", { className: "font-medium text-sm", children: r.description }), e.jsxs("div", { className: "text-[10px] text-muted-foreground mt-2 font-mono flex items-center gap-2", children: [e.jsx(x, { variant: "outline", className: "text-[9px] font-mono py-0 h-4 shrink-0", children: "Condition" }), e.jsx("span", { className: "truncate", children: $(r.condition) })] })] })] }, r.key)) })] }), e.jsxs(c, { children: [e.jsx(d, { children: e.jsxs(o, { className: "text-lg flex items-center gap-2", children: [e.jsx(J, { className: "w-5 h-5 text-secondary" }), "\u53D8\u91CF\u914D\u7F6E (Variables)"] }) }), e.jsx(m, { children: e.jsx("div", { className: "grid grid-cols-1 sm:grid-cols-2 gap-3", children: Object.entries(l.challenge.variables).map(([r, a]) => e.jsxs("div", { className: "p-3 rounded-md bg-muted/30 border flex justify-between items-center", children: [e.jsxs("div", { className: "space-y-1", children: [e.jsx("div", { className: "text-xs font-bold font-mono", children: r }), e.jsxs("div", { className: "text-[10px] text-muted-foreground", children: ["\u521D\u59CB\u503C: ", String(a.initial ?? "null")] })] }), e.jsx(x, { variant: "secondary", className: "text-[10px] capitalize", children: a.type })] }, r)) }) })] })] }), fe = (l) => {
  const r = z();
  return e.jsxs("div", { className: "space-y-6", children: [e.jsxs(c, { className: "border-primary/20 bg-primary/5", children: [e.jsxs(d, { children: [e.jsxs(o, { className: "text-lg flex items-center gap-2", children: [e.jsx(V, { className: "w-5 h-5 text-primary" }), "\u4EE5\u6B64\u5267\u672C\u5F00\u542F\u65B0\u6311\u6218"] }), e.jsx(f, { children: "\u8BF7\u9009\u62E9\u4E00\u4E2A\u89D2\u8272\u4F5C\u4E3A\u6311\u6218\u7684\u4E3B\u89D2" })] }), e.jsx(m, { className: "space-y-3", children: e.jsx("div", { className: "grid grid-cols-1 gap-2", children: l.characters.map((a) => e.jsxs(n, { variant: "outline", className: "w-full justify-start gap-4 h-14 bg-background", onClick: () => l.onStartNew(a.id), type: "button", children: [e.jsx("div", { className: "w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0", children: e.jsx(q, { className: "w-4 h-4 text-muted-foreground" }) }), e.jsxs("div", { className: "text-left", children: [e.jsxs("div", { className: "font-semibold text-sm", children: ["\u4F7F\u7528 ", a.name] }), e.jsx("div", { className: "text-[10px] text-muted-foreground truncate max-w-50", children: a.description })] })] }, a.id)) }) })] }), e.jsxs(c, { children: [e.jsx(d, { children: e.jsx(o, { className: "text-lg", children: "\u5DF2\u5B58\u6311\u6218\u8FDB\u5EA6" }) }), e.jsx(m, { className: "space-y-3", children: l.sessions.length > 0 ? l.sessions.map((a) => e.jsxs(n, { className: "w-full justify-between items-center h-auto py-4 px-5 border hover:bg-muted/50 transition-colors", variant: "ghost", onClick: () => r({ to: "/session/$sessionId", params: { sessionId: a.id } }), type: "button", children: [e.jsxs("div", { className: "flex items-center gap-4", children: [e.jsx("div", { className: "w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center", children: e.jsx(Q, { className: "w-6 h-6 text-primary" }) }), e.jsxs("div", { className: "text-left", children: [e.jsx("div", { className: "font-semibold", children: "\u7EE7\u7EED\u6311\u6218" }), e.jsxs("div", { className: "text-xs text-muted-foreground mt-1", children: ["\u6700\u540E\u6D3B\u8DC3: ", new Date(a.updatedAt).toLocaleString()] })] })] }), e.jsxs("div", { className: "flex flex-col items-end gap-1", children: [e.jsx(x, { variant: "outline", className: "text-[9px] h-5", children: "\u4EE5\u6B64\u5267\u672C\u8FDB\u53D1" }), e.jsx("span", { className: "text-[10px] text-muted-foreground italic", children: a.characterId ? `\u89D2\u8272 ID: ${a.characterId.slice(0, 8)}...` : "\u672A\u77E5\u89D2\u8272" })] })] }, a.id)) : e.jsx("div", { className: "text-center py-10 border rounded-lg border-dashed", children: e.jsx("p", { className: "text-muted-foreground text-sm", children: "\u8FD8\u6CA1\u6709\u57FA\u4E8E\u6B64\u5267\u672C\u7684\u6311\u6218\u8BB0\u5F55" }) }) })] })] });
};
function He() {
  var _a;
  const { challengeId: l } = ge.useParams(), r = z(), { data: a = [] } = g((s) => s.from({ c: G })), t = a.find((s) => s.id === l), { data: p = [] } = g((s) => s.from({ s: R })), { data: N = [] } = g((s) => s.from({ char: U })), M = p.filter((s) => s.challengeId === l), [O, v] = k.useState(false), [h, L] = k.useState(null);
  if (!t) return e.jsxs("div", { className: "p-20 text-center flex flex-col items-center gap-4", children: [e.jsx("p", { className: "text-muted-foreground", children: "\u6311\u6218\u4E0D\u5B58\u5728" }), e.jsx(n, { onClick: () => r({ to: "/plaza/challenges" }), variant: "outline", type: "button", children: "\u8FD4\u56DE\u5217\u8868" })] });
  const P = (s) => {
    L(s), v(true);
  }, B = async () => {
    if (h) try {
      const s = ie(), C = Date.now(), S = {};
      for (const [i, F] of Object.entries(t.variables)) S[i] = { key: i, value: F.initial };
      const E = { id: s, title: `${t.name}`, contextId: null, mode: "challenge", modeConfig: { characterId: h, roleTaskPrompt: t.roleTaskPrompt, userGuidance: t.userGuidance, variables: t.variables, goals: t.goals, failureChecks: t.failureChecks }, modeState: { currentPhase: "dm_intro", currentUIState: "idle", variableStates: S, goalStates: t.goals.map((i) => ({ key: i.key, checkCount: 0, isMet: false })), failureStates: t.failureChecks.map((i) => ({ key: i.key, checkCount: 0, isMet: false })) }, characterId: h, challengeId: t.id, createdAt: C, updatedAt: C, isActive: true };
      await D.sessions.add(E), r({ to: "/session/$sessionId", params: { sessionId: s }, search: { mode: "challenge" } });
    } catch (s) {
      console.error("Failed to create challenge session:", s), u.error("\u521B\u5EFA\u4F1A\u8BDD\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5");
    }
  }, b = N.find((s) => s.id === h), y = b ? { mode: "challenge", character: b, challenge: t, onConfirm: B } : null, w = () => {
    u.success(`\u6B63\u5728\u5BFC\u51FA\u6311\u6218 ${t.name}...`);
  };
  return e.jsxs("div", { className: "max-w-5xl mx-auto p-4 md:p-8 space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-500 relative", children: [e.jsxs("div", { className: "flex items-center justify-between", children: [e.jsxs(n, { variant: "ghost", size: "sm", className: "mb-2 -ml-2 text-muted-foreground hover:bg-transparent", onClick: () => r({ to: "/plaza/challenges" }), type: "button", children: [e.jsx(_, { className: "w-4 h-4 mr-1" }), " \u8FD4\u56DE\u6311\u6218\u5E7F\u573A"] }), e.jsxs("div", { className: "flex items-center gap-2", children: [e.jsxs(n, { variant: "outline", size: "sm", className: "hidden sm:flex gap-2 h-8 rounded-lg", onClick: w, type: "button", children: [e.jsx(I, { className: "w-4 h-4" }), "\u5BFC\u51FA\u6311\u6218"] }), e.jsxs(ae, { children: [e.jsx(te, { asChild: true, children: e.jsx(n, { variant: "ghost", size: "icon", className: "h-8 w-8 rounded-full", type: "button", children: e.jsx(K, { className: "w-4 h-4" }) }) }), e.jsxs(re, { align: "end", className: "w-48", children: [e.jsxs(j, { onClick: w, className: "sm:hidden", children: [e.jsx(I, { className: "mr-2 h-4 w-4" }), " \u5BFC\u51FA JSON"] }), e.jsxs(j, { children: [e.jsx(X, { className: "mr-2 h-4 w-4" }), " \u5206\u4EAB\u6311\u6218"] }), e.jsxs(ne, { children: [e.jsx(ce, { asChild: true, children: e.jsxs(j, { onSelect: (s) => s.preventDefault(), className: "text-destructive focus:bg-destructive/10 focus:text-destructive", children: [e.jsx(Y, { className: "mr-2 h-4 w-4" }), " \u5220\u9664\u6311\u6218"] }) }), e.jsxs(de, { children: [e.jsxs(oe, { children: [e.jsx(me, { children: "\u786E\u8BA4\u5220\u9664\u6311\u6218" }), e.jsxs(xe, { children: ["\u786E\u5B9A\u8981\u5220\u9664\u6311\u6218\u300C", t.name, "\u300D\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002"] })] }), e.jsxs(he, { children: [e.jsx(pe, { children: "\u53D6\u6D88" }), e.jsx(ue, { className: "bg-destructive hover:bg-destructive/90", onClick: async () => {
    await D.challenges.delete(t.id), u.success("\u6311\u6218\u5DF2\u5220\u9664"), r({ to: "/plaza/challenges" });
  }, children: "\u786E\u8BA4\u5220\u9664" })] })] })] })] })] })] })] }), e.jsxs("div", { className: "flex flex-col md:flex-row gap-8 items-start pb-8 border-b", children: [e.jsx("div", { className: "w-40 h-40 rounded-3xl bg-primary/10 flex items-center justify-center shrink-0 border-4 border-background shadow-xl overflow-hidden", children: e.jsx(Z, { className: "w-20 h-20 text-primary" }) }), e.jsxs("div", { className: "space-y-4 grow", children: [e.jsxs("div", { className: "space-y-2", children: [e.jsx(x, { variant: "outline", className: "text-primary bg-primary/5 border-primary/20 uppercase tracking-widest text-[10px] px-2", children: "Challenge Scenario" }), e.jsx("h1", { className: "text-4xl font-extrabold tracking-tight", children: t.name })] }), e.jsx("div", { className: "flex flex-wrap gap-2", children: (_a = t.tags) == null ? void 0 : _a.map((s) => e.jsx(x, { variant: "secondary", className: "px-3 py-1 font-medium", children: s }, s)) }), e.jsxs("p", { className: "text-lg leading-relaxed text-muted-foreground italic font-serif", children: ['" ', t.description.slice(0, 150), '... "'] })] })] }), e.jsxs(ee, { defaultValue: "details", className: "w-full", children: [e.jsxs(se, { className: "w-full justify-start h-12 bg-muted/50 p-1 mb-6", children: [e.jsx(T, { value: "details", className: "px-8 h-10 data-[state=active]:shadow-sm", children: "\u6311\u6218\u8BE6\u60C5" }), e.jsx(T, { value: "sessions", className: "px-8 h-10 data-[state=active]:shadow-sm", children: "\u5173\u8054\u4F1A\u8BDD" })] }), e.jsx(A, { value: "details", className: "mt-0", children: e.jsx(je, { challenge: t }) }), e.jsx(A, { value: "sessions", className: "mt-0", children: e.jsx(fe, { challengeId: t.id, sessions: M, characters: N, onStartNew: P }) })] }), y && e.jsx(le, { open: O, onOpenChange: v, wizardProps: y })] });
}
export {
  He as component
};
