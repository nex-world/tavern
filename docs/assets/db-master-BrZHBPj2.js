var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);
import { k as y, m as v, n as z, j as J } from "./@tanstack-3iyDWv8L.js";
import { o as i, s as e, n as t, a as o, r as p, c as _, l as n, b as r, _ as c, u, t as h, d as Q } from "./zod-fbN9ubnj.js";
import { D as I } from "./dexie-C2pyTzVO.js";
import { F as H, ak as W } from "./react-D9TtqY-V.js";
const Y = i({ keys: o(e()).describe("\u5173\u952E\u8BCD\u6570\u7EC4\uFF0C\u7528\u4E8E\u5339\u914D\u804A\u5929\u65E5\u5FD7"), content: e().describe("\u5185\u5BB9\uFF0C\u5982\u679C\u5339\u914D\u5219\u6DFB\u52A0\u5230\u63D0\u793A\u8BCD\u4E2D"), extensions: p(e(), _()).describe("\u6269\u5C55\u5B57\u6BB5"), enabled: r().describe("\u662F\u5426\u542F\u7528"), insertion_order: t().describe("\u63D2\u5165\u987A\u5E8F\uFF0C\u6570\u5B57\u8D8A\u5C0F\u8D8A\u65E9\u63D2\u5165"), case_sensitive: r().optional().describe("\u662F\u5426\u533A\u5206\u5927\u5C0F\u5199"), constant: r().optional().describe("\u662F\u5426\u4E3A\u5E38\u91CF\u5339\u914D"), name: e().optional().describe("\u6761\u76EE\u540D\u79F0"), priority: t().optional().describe("\u4F18\u5148\u7EA7"), id: t().optional().describe("\u6761\u76EEID"), comment: e().optional().describe("\u6CE8\u91CA"), selective: r().optional().describe("\u662F\u5426\u9009\u62E9\u6027\u5339\u914D"), secondary_keys: o(e()).optional().describe("\u6B21\u8981\u5173\u952E\u8BCD"), position: c(["before_char", "after_char"]).optional().describe("\u63D2\u5165\u4F4D\u7F6E") }), Z = i({ keys: o(e()).describe("\u5173\u952E\u8BCD\u6570\u7EC4\uFF0C\u7528\u4E8E\u5339\u914D\u804A\u5929\u65E5\u5FD7"), content: e().describe("\u5185\u5BB9\uFF0C\u5982\u679C\u5339\u914D\u5219\u6DFB\u52A0\u5230\u63D0\u793A\u8BCD\u4E2D"), extensions: p(e(), _()).describe("\u6269\u5C55\u5B57\u6BB5"), enabled: r().describe("\u662F\u5426\u542F\u7528"), insertion_order: t().describe("\u63D2\u5165\u987A\u5E8F\uFF0C\u6570\u5B57\u8D8A\u5C0F\u8D8A\u65E9\u63D2\u5165"), case_sensitive: r().optional().describe("\u662F\u5426\u533A\u5206\u5927\u5C0F\u5199"), use_regex: r().optional().describe("\u662F\u5426\u4F7F\u7528\u6B63\u5219\u8868\u8FBE\u5F0F\u5339\u914D"), constant: r().optional().describe("\u662F\u5426\u4E3A\u5E38\u91CF\u5339\u914D"), name: e().optional().describe("\u6761\u76EE\u540D\u79F0"), priority: t().optional().describe("\u4F18\u5148\u7EA7"), id: u([t(), e()]).optional().describe("\u6761\u76EEID"), comment: e().optional().describe("\u6CE8\u91CA"), selective: r().optional().describe("\u662F\u5426\u9009\u62E9\u6027\u5339\u914D"), secondary_keys: o(e()).optional().describe("\u6B21\u8981\u5173\u952E\u8BCD"), position: c(["before_char", "after_char"]).optional().describe("\u63D2\u5165\u4F4D\u7F6E") }), ee = u([Y, Z]), P = i({ name: e().optional().describe("\u77E5\u8BC6\u4E66\u540D\u79F0"), description: e().optional().describe("\u77E5\u8BC6\u4E66\u63CF\u8FF0"), scan_depth: t().optional().describe("\u626B\u63CF\u6DF1\u5EA6\uFF0C\u68C0\u67E5\u6700\u8FD1\u591A\u5C11\u6761\u6D88\u606F"), token_budget: t().optional().describe("\u4EE4\u724C\u9884\u7B97\uFF0C\u8D85\u8FC7\u5219\u79FB\u9664\u4F4E\u4F18\u5148\u7EA7\u6761\u76EE"), recursive_scanning: r().optional().describe("\u662F\u5426\u542F\u7528\u9012\u5F52\u626B\u63CF"), extensions: p(e(), _()).describe("\u6269\u5C55\u5B57\u6BB5"), entries: o(ee).describe("\u6761\u76EE\u6570\u7EC4") }), ae = i({ type: e().describe("\u8D44\u4EA7\u7C7B\u578B\uFF0C\u5982 'icon', 'background' \u7B49"), uri: e().describe("\u8D44\u4EA7URI"), name: e().describe("\u8D44\u4EA7\u540D\u79F0"), ext: e().describe("\u6587\u4EF6\u6269\u5C55\u540D") }), V = i({ name: e().describe("\u89D2\u8272\u540D\u79F0\u3010v1\u3011"), description: e().describe("\u89D2\u8272\u63CF\u8FF0\u3010v1\u3011"), creator: e().describe("\u521B\u5EFA\u8005\u3010v2\u3011"), creator_notes: e().describe("\u521B\u5EFA\u8005\u7B14\u8BB0\u3010v2\u3011"), creator_notes_multilingual: p(e(), e()).optional().describe("\u591A\u8BED\u8A00\u521B\u5EFA\u8005\u7B14\u8BB0\u3010v3\u3011"), extensions: p(e(), _()).describe("\u53EF\u81EA\u5B9A\u4E49\u7684\u6269\u5C55\u5B57\u6BB5\u3010v2\u3011"), assets: o(ae).optional().describe("\u8D44\u4EA7\u6570\u7EC4\u3010v3\u3011"), system_prompt: e().describe("\u7CFB\u7EDF\u63D0\u793A\u8BCD(\u6A21\u677F)\u3010v2\u3011"), post_history_instructions: e().describe("\u5386\u53F2\u6307\u4EE4\u540E\u7F00(\u6A21\u677F)\u3010v2\u3011"), nickname: e().optional().describe("\u6635\u79F0\u3010v3\u3011"), personality: e().describe("\u4EBA\u683C\u6216\u4E2A\u6027\u63CF\u8FF0\u3010v1\u3011"), mes_example: e().describe("\u6D88\u606F\u793A\u4F8B\u3010v1\u3011"), first_mes: e().describe("\u7B2C\u4E00\u6761\u6D88\u606F\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), alternate_greetings: o(e()).describe("\u5907\u7528\u95EE\u5019\u8BED\u6570\u7EC4\u3010v2\u3011"), group_only_greetings: o(e()).describe("\u4EC5\u7FA4\u804A\u95EE\u5019\u8BED\u3010v3\u3011"), scenario: e().describe("\u573A\u666F\u63CF\u8FF0\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), character_book: P.optional().describe("\u89D2\u8272\u7279\u5B9A\u77E5\u8BC6\u4E66\u3010\u90E8\u5206\u529F\u80FD\uFF08\u5982\u88C5\u9970\u5668\uFF09\u9650\u5355\u804A\u4F7F\u7528\u3011\u3010v2\u3011"), character_version: e().describe("\u89D2\u8272\u7248\u672C\u3010v2\u3011"), tags: o(e()).describe("\u6807\u7B7E\u6570\u7EC4\uFF0C\u7528\u4E8E\u7B5B\u9009\uFF0C\u5927\u5C0F\u5199\u654F\u611F\u3010v2\u3011"), source: o(e()).optional().describe("\u6765\u6E90\u6570\u7EC4\uFF0C\u4FBF\u4E8E\u6EAF\u6E90\u6216\u81EA\u52A8\u66F4\u65B0\u7B49\u3010v3\u3011"), creation_date: t().optional().describe("\u521B\u5EFA\u65E5\u671F\uFF08Unix\u65F6\u95F4\u6233\uFF09\u3010v3\u3011"), modification_date: t().optional().describe("\u4FEE\u6539\u65E5\u671F\uFF08Unix\u65F6\u95F4\u6233\uFF09\u3010v3\u3011") }), te = i({ name: e().describe("\u89D2\u8272\u540D\u79F0\u3010v1\u3011"), description: e().describe("\u89D2\u8272\u63CF\u8FF0\u3010v1\u3011"), personality: e().describe("\u4EBA\u683C\u6216\u4E2A\u6027\u63CF\u8FF0\u3010v1\u3011"), scenario: e().describe("\u573A\u666F\u63CF\u8FF0\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), first_mes: e().describe("\u7B2C\u4E00\u6761\u6D88\u606F\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), mes_example: e().describe("\u6D88\u606F\u793A\u4F8B\u3010v1\u3011"), creator_notes: e().describe("\u521B\u5EFA\u8005\u7B14\u8BB0\u3010v2\u3011"), system_prompt: e().describe("\u7CFB\u7EDF\u63D0\u793A\u8BCD(\u6A21\u677F)\u3010v2\u3011"), post_history_instructions: e().describe("\u5386\u53F2\u6307\u4EE4\u540E\u7F00(\u6A21\u677F)\u3010v2\u3011"), alternate_greetings: o(e()).describe("\u5907\u7528\u95EE\u5019\u8BED\u6570\u7EC4\u3010v2\u3011"), character_book: P.optional().describe("\u89D2\u8272\u7279\u5B9A\u77E5\u8BC6\u4E66\u3010\u90E8\u5206\u529F\u80FD\uFF08\u5982\u88C5\u9970\u5668\uFF09\u9650\u5355\u804A\u4F7F\u7528\u3011\u3010v2\u3011"), tags: o(e()).describe("\u6807\u7B7E\u6570\u7EC4\uFF0C\u7528\u4E8E\u7B5B\u9009\uFF0C\u5927\u5C0F\u5199\u654F\u611F\u3010v2\u3011"), creator: e().describe("\u521B\u5EFA\u8005\u3010v2\u3011"), character_version: e().describe("\u89D2\u8272\u7248\u672C\u3010v2\u3011"), extensions: p(e(), _()).describe("\u53EF\u81EA\u5B9A\u4E49\u7684\u6269\u5C55\u5B57\u6BB5\u3010v2\u3011") });
i({ spec: n("chara_card_v2").describe("\u89C4\u8303\u6807\u8BC6"), spec_version: n("2.0").describe("\u89C4\u8303\u7248\u672C"), data: te.describe("\u6570\u636E") });
const je = i({ spec: n("chara_card_v3").describe("\u89C4\u8303\u6807\u8BC6"), spec_version: n("3.0").describe("\u89C4\u8303\u7248\u672C"), data: V.describe("\u6570\u636E") }), Le = i({ name: e().describe("\u89D2\u8272\u540D\u79F0\u3010v1\u3011"), description: e().describe("\u89D2\u8272\u63CF\u8FF0\u3010v1\u3011"), personality: e().describe("\u4EBA\u683C\u6216\u4E2A\u6027\u63CF\u8FF0\u3010v1\u3011"), scenario: e().describe("\u573A\u666F\u63CF\u8FF0\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), first_mes: e().describe("\u7B2C\u4E00\u6761\u6D88\u606F\u3010v1\u3011\u3010\u9650\u5355\u804A\u4F7F\u7528\u3011"), mes_example: e().describe("\u6D88\u606F\u793A\u4F8B\u3010v1\u3011") }), se = V.extend({ id: e().describe("\u89D2\u8272\u5361ID"), avatar: e().optional().describe("\u5934\u50CFURI"), imageBase64: e().optional().describe("PNG\u56FE\u50CFBase64\u6570\u636E"), createdAt: t().optional().describe("\u521B\u5EFA\u65F6\u95F4"), updatedAt: t().optional().describe("\u66F4\u65B0\u65F6\u95F4") }), l = i({ id: e().optional().describe("\u4E0A\u4E0B\u6587\u9879 ID"), idx: t().optional().describe("\u4E0A\u4E0B\u6587\u9879\u7D22\u5F15\u4F4D\u7F6E"), orderRef: t().optional().describe("\u4E0A\u4E0B\u6587\u9879\u6392\u5E8F\u53C2\u8003\u503C").default(0), type: e().optional().describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\u6807\u7B7E").default("default"), data: _().describe("\u4E0A\u4E0B\u6587\u5185\u5BB9"), hidden: r().optional().nullable().describe("\u662F\u5426\u9690\u85CF\u8BE5\u4E0A\u4E0B\u6587\u9879"), processing: r().optional().nullable().describe("\u4E0A\u4E0B\u6587\u9879\u5904\u7406\u72B6\u6001\uFF0C\u5904\u7406\u4E2D\u8BBE\u7F6E\u4E3A true\uFF0C\u5904\u7406\u5B8C\u6BD5\u8BBE\u7F6E\u4E3A undefined"), timestamp: t().optional().nullable().describe("\u6D88\u606F\u65F6\u95F4\u6233"), deleted: r().optional().nullable().describe("\u662F\u5426\u5DF2\u5220\u9664\u8BE5\u4E0A\u4E0B\u6587\u9879") }), Ue = i({ historyItems: l.array().describe("\u4E0A\u4E0B\u6587\u9879\u6570\u7EC4"), processingItem: l.optional().describe("\u6B63\u5728\u5904\u7406\u4E2D\u7684\u4E0A\u4E0B\u6587\u9879(\u9650\u4E00\u9879)") });
i({ role: c(["system", "user", "assistant", "tool"]).describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") });
l.extend({ type: n("llm_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1ALLM\u6D88\u606F"), data: i({ role: c(["system", "user", "assistant", "tool"]).describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") }).describe("\u4E0D\u63A8\u8350\u4F7F\u7528\uFF0C\u56E0\u4E3A\u4E0A\u4E0B\u6587\u7BA1\u7406\u5E94\u8BE5\u4F7F\u7528\u66F4\u52A0\u7CBE\u7EC6\u7684\u7ED3\u6784\u3002LLM\u6D88\u606F\u4E0A\u4E0B\u6587\u9879\u53EA\u662F\u6700\u6734\u7D20\u7684\u5F62\u5F0F\u3002");
l.extend({ type: n("starting_system_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u8D77\u59CB\u7CFB\u7EDF\u6D88\u606F"), data: i({ role: n("system").optional().describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("in_context_system_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u4E0A\u4E0B\u6587\u4E4B\u4E2D\u7684\u7CFB\u7EDF\u6D88\u606F"), data: i({ role: n("system").optional().describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("tool_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u5DE5\u5177\u6D88\u606F"), data: i({ role: n("tool").optional().describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("story_telling").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u8BB2\u6545\u4E8B\u6D88\u606F"), data: i({ role: c(["system", "user", "assistant", "tool"]).describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
const O = i({ isCharacter: r().optional().default(false).describe("\u662F\u5426\u4E3A\u89D2\u8272\u6D88\u606F"), isEnv: r().optional().default(false).describe("\u662F\u5426\u4E3A\u73AF\u5883\u6D88\u606F"), isDM: r().optional().default(false).describe("\u662F\u5426\u4E3ADM\u6D88\u606F"), isUser: r().optional().default(false).describe("\u662F\u5426\u4E3A\u7528\u6237\u6D88\u606F"), characterId: e().optional().describe("\u89D2\u8272 ID"), userId: e().optional().describe("\u7528\u6237 ID"), content: e().describe("\u6D88\u606F\u5185\u5BB9"), timestamp: t().optional().describe("\u6D88\u606F\u65F6\u95F4\u6233"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0"), role: c(["system", "user", "assistant", "tool"]).optional().describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272") }), ie = l.extend({ type: n("participant_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u53C2\u4E0E\u8005\u6D88\u606F"), data: O.describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") }), R = i({ isCharacter: r().optional().default(false).describe("\u662F\u5426\u4E3A\u89D2\u8272\u6D88\u606F"), isEnv: r().optional().default(false).describe("\u662F\u5426\u4E3A\u73AF\u5883\u6D88\u606F"), isDM: r().optional().default(false).describe("\u662F\u5426\u4E3ADM\u6D88\u606F"), isUser: r().optional().default(false).describe("\u662F\u5426\u4E3A\u7528\u6237\u6D88\u606F"), characterId: e().optional().describe("\u89D2\u8272 ID"), userId: e().optional().describe("\u7528\u6237 ID"), list: o(i({ content: e().describe("\u6D88\u606F\u5185\u5BB9"), timestamp: t().optional().describe("\u6D88\u606F\u65F6\u95F4\u6233"), originalIdx: t().optional().describe("\u539F\u59CB\u7D22\u5F15\u4F4D\u7F6E") })).describe("\u6D88\u606F\u5217\u8868"), name: e().optional().describe("\u53D1\u9001\u8005\u540D\u79F0"), role: c(["system", "user", "assistant", "tool"]).optional().describe("\u6D88\u606F\u53D1\u9001\u8005\u7684\u89D2\u8272") });
l.extend({ type: n("participant_message_group").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u53C2\u4E0E\u8005\u6D88\u606F\u7EC4"), data: R.describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
ie.extend({ type: n("character_message").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u89D2\u8272\u6D88\u606F"), data: O.extend({ characterId: e().describe("\u89D2\u8272 ID") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("character_message_group").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u89D2\u8272\u6D88\u606F\u7EC4"), data: R.extend({ characterId: e().describe("\u89D2\u8272 ID") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("placeholder").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u5360\u4F4D\u7B26"), data: _().nullable().optional().describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9"), hidden: n(true).describe("\u5360\u4F4D\u7B26\u4E0A\u4E0B\u6587\u9879\u9ED8\u8BA4\u9690\u85CF") });
l.extend({ type: n("alert").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u7A0B\u5E8F\u63D0\u793A"), data: i({ type: c(["info", "warning", "error", "success", "secondary", "contrast"]).describe("\u7A0B\u5E8F\u63D0\u793A\u7C7B\u578B"), content: e().describe("\u5185\u5BB9"), timestamp: t().optional().describe("\u65F6\u95F4\u6233") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("summary").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u6458\u8981"), data: i({ range: h([t().describe("\u8D77\u59CB\u7D22\u5F15\u4F4D\u7F6E"), t().describe("\u7ED3\u675F\u7D22\u5F15\u4F4D\u7F6E")]).describe("\u6458\u8981\u8986\u76D6\u7684\u5185\u5BB9\u8303\u56F4"), content: e().describe("\u6458\u8981\u5185\u5BB9") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("annotation").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u6CE8\u89E3"), data: i({ target: t().describe("\u6CE8\u89E3\u76EE\u6807\u7684\u7D22\u5F15\u4F4D\u7F6E"), content: e().describe("\u6CE8\u89E3\u5185\u5BB9") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("performance_command").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u6F14\u51FA\u6307\u4EE4"), data: i({ anchor: t().describe("\u6F14\u51FA\u6307\u4EE4\u7684\u951A\u70B9\u4F4D\u7F6E"), command: o(_()).describe("\u6F14\u51FA\u6307\u4EE4\u5185\u5BB9") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("dm_intro").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1ADM \u5F00\u573A\u767D"), data: i({ content: e().describe("DM \u5F00\u573A\u767D\u5185\u5BB9") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
l.extend({ type: n("character_intro").describe("\u4E0A\u4E0B\u6587\u9879\u7C7B\u578B\uFF1A\u89D2\u8272\u5F00\u573A\u767D"), data: i({ characterId: e().optional().describe("\u89D2\u8272ID"), content: e().describe("\u89D2\u8272\u5F00\u573A\u767D\u5185\u5BB9"), timestamp: t().optional().describe("\u6D88\u606F\u65F6\u95F4\u6233") }).describe("\u4E0A\u4E0B\u6587\u9879\u5185\u5BB9") });
const re = i({ id: e().describe("\u4F1A\u8BDDID"), title: e().optional().describe("\u4F1A\u8BDD\u6807\u9898"), contextId: e().optional().nullable().describe("\u5173\u8054\u7684\u4E0A\u4E0B\u6587\u7684ID"), mode: e().describe("\u6A21\u5F0F"), modeConfig: p(e(), _()).describe("\u6A21\u5F0F\u914D\u7F6E"), modeState: p(e(), _()).describe("\u6A21\u5F0F\u4E13\u7528\u72B6\u6001"), createdAt: t().describe("\u521B\u5EFA\u65F6\u95F4"), updatedAt: t().describe("\u66F4\u65B0\u65F6\u95F4"), isActive: r().optional().describe("\u662F\u5426\u6D3B\u8DC3") }), ne = i({ key: e().describe("\u53D8\u91CF\u952E"), type: n("boolean").describe("\u53D8\u91CF\u7C7B\u578B"), description: e().optional().describe("\u53D8\u91CF\u63CF\u8FF0"), hidden: r().describe("\u662F\u5426\u9690\u85CF(\u754C\u9762\u4E0D\u663E\u793A)"), initial: r().describe("\u521D\u59CB\u503C") }), ce = i({ key: e().describe("\u53D8\u91CF\u952E"), type: n("number").describe("\u53D8\u91CF\u7C7B\u578B"), description: e().optional().describe("\u53D8\u91CF\u63CF\u8FF0"), hidden: r().describe("\u662F\u5426\u9690\u85CF(\u754C\u9762\u4E0D\u663E\u793A)"), initial: t().describe("\u521D\u59CB\u503C"), min: t().optional().describe("\u6700\u5C0F\u503C"), max: t().optional().describe("\u6700\u5927\u503C"), minDelta: t().optional().describe("(\u7EDD\u5BF9\u503C\u7684)\u6700\u5C0F\u53D8\u5316\u5E45\u5EA6"), maxDelta: t().optional().describe("(\u7EDD\u5BF9\u503C\u7684)\u6700\u5927\u53D8\u5316\u5E45\u5EA6"), asPercent: r().optional().describe("\u662F\u5426\u4E3A\u767E\u5206\u6BD4(\u754C\u9762\u6DFB\u52A0\u767E\u5206\u53F7)") }), oe = i({ key: e().describe("\u53D8\u91CF\u952E"), type: n("string").describe("\u53D8\u91CF\u7C7B\u578B"), description: e().optional().describe("\u53D8\u91CF\u63CF\u8FF0"), hidden: r().describe("\u662F\u5426\u9690\u85CF(\u754C\u9762\u4E0D\u663E\u793A)"), initial: e().describe("\u521D\u59CB\u503C"), asEnum: r().optional().describe("\u662F\u5426\u4E3A\u679A\u4E3E"), enumValues: o(e()).optional().describe("\u679A\u4E3E\u503C\u5217\u8868") }), de = i({ key: e().describe("\u53D8\u91CF\u952E"), type: n("tags").describe("\u53D8\u91CF\u7C7B\u578B"), description: e().optional().describe("\u53D8\u91CF\u63CF\u8FF0"), hidden: r().describe("\u662F\u5426\u9690\u85CF(\u754C\u9762\u4E0D\u663E\u793A)"), initial: o(e()).describe("\u521D\u59CB\u6807\u7B7E\u5217\u8868"), asEnum: r().optional().describe("\u662F\u5426\u4E3A\u679A\u4E3E"), enumValues: o(e()).optional().describe("\u679A\u4E3E\u503C\u5217\u8868") }), j = Q("type", [ne, ce, oe, de]);
p(e(), j).describe("\u53D8\u91CF\u914D\u7F6E\u5B57\u5178");
const le = i({ key: e().describe("\u53D8\u91CF\u952E"), value: u([r(), t(), e(), o(e())]).describe("\u53D8\u91CF\u503C") }), be = p(e(), le).describe("\u53D8\u91CF\u5B57\u5178");
c(["setTrue", "setFalse", "toggle", "delta", "setTo", "setValue", "add", "remove"]);
const pe = h([c(["setTrue", "setFalse", "toggle"]), e().describe("\u53D8\u91CF\u952E")]).describe("\u64CD\u4F5C\u5143\u7EC4\uFF1A\u5E03\u5C14\u7C7B\u578B"), me = h([c(["delta", "setTo", "setValue"]), e().describe("\u53D8\u91CF\u952E"), t().describe("\u64CD\u4F5C\u503C")]).describe("\u64CD\u4F5C\u5143\u7EC4\uFF1A\u6570\u5B57\u7C7B\u578B"), _e = h([c(["setTo", "setValue"]), e().describe("\u53D8\u91CF\u952E"), e().describe("\u64CD\u4F5C\u503C")]).describe("\u64CD\u4F5C\u5143\u7EC4\uFF1A\u5B57\u7B26\u4E32\u7C7B\u578B"), he = h([c(["add", "remove"]), e().describe("\u53D8\u91CF\u952E"), e().describe("\u64CD\u4F5C\u503C")]).describe("\u64CD\u4F5C\u5143\u7EC4\uFF1A\u6807\u7B7E\u7C7B\u578B");
u([pe, me, _e, he]).describe("\u53D8\u91CF\u64CD\u4F5C\u5143\u7EC4");
c(["isTrue", "isFalse", "eq", "is", "neq", "isNot", "gt", "gte", "lt", "lte", "includes", "notIncludes", "has", "hasAny", "hasAll", "llmJudge", "and", "or", "all", "any", "some"]);
const ue = h([c(["isTrue", "isFalse"]), e().describe("\u53D8\u91CF\u952E")]).describe("\u6761\u4EF6\u5143\u7EC4\uFF1A\u5E03\u5C14\u7C7B\u578B"), ge = h([c(["eq", "neq", "is", "isNot"]), e().describe("\u53D8\u91CF\u952E"), u([e(), t(), r()]).describe("\u6BD4\u8F83\u503C(\u5B9E\u9645\u90FD\u8F6C\u6210\u5B57\u7B26\u4E32\u518D\u5904\u7406)")]).describe("\u6761\u4EF6\u5143\u7EC4\uFF1A\u5B57\u9762\u91CF\u7C7B\u578B"), ye = h([c(["gt", "gte", "lt", "lte"]), e().describe("\u53D8\u91CF\u952E"), t().describe("\u6BD4\u8F83\u503C")]).describe("\u6761\u4EF6\u5143\u7EC4\uFF1A\u6570\u5B57\u7C7B\u578B"), fe = h([c(["includes", "notIncludes", "has", "hasAny", "hasAll", "llmJudge"]), e().describe("\u53D8\u91CF\u952E"), u([e(), t(), r()]).describe("\u53C2\u8003\u503C(\u5B9E\u9645\u90FD\u8F6C\u6210\u5B57\u7B26\u4E32\u518D\u5904\u7406)")]).describe("\u6761\u4EF6\u5143\u7EC4\uFF1A\u5185\u5BB9\u7C7B\u578B(\u5B57\u7B26\u4E32\u548C\u6807\u7B7E)"), Se = h([c(["hasAny", "hasAll"]), e().describe("\u53D8\u91CF\u952E"), u([e(), t(), r()]).array().describe("\u53C2\u8003\u503C(\u5B9E\u9645\u90FD\u8F6C\u6210\u5B57\u7B26\u4E32\u518D\u5904\u7406)")]).describe("\u6761\u4EF6\u5143\u7EC4\uFF1A\u5185\u5BB9\u6570\u7EC4\u7C7B\u578B(\u5B57\u7B26\u4E32\u548C\u6807\u7B7E)"), D = u([ue, ge, ye, fe, Se]).describe("\u6761\u4EF6\u5143\u7EC4"), L = h([c(["and", "or", "all", "any", "some"]), o(D).describe("\u5B50\u6761\u4EF6\u5143\u7EC4\u6570\u7EC4")]).describe("\u7B80\u5355\u590D\u5408\u6761\u4EF6\u5143\u7EC4"), Ie = h([c(["and", "or", "all", "any", "some"]), u([D, L]).array().describe("\u5B50\u6761\u4EF6\u5143\u7EC4\u6570\u7EC4")]).describe("\u590D\u6742\u590D\u5408\u6761\u4EF6\u5143\u7EC4"), xe = u([D, L, Ie]).describe("\u6761\u4EF6\u5143\u7EC4\uFF08\u652F\u6301\u5355\u4E00\u6761\u4EF6\u548C\u590D\u5408\u6761\u4EF6\uFF09"), F = i({ key: e().describe("\u68C0\u67E5\u9879\u952E"), description: e().describe("\u68C0\u67E5\u9879\u63CF\u8FF0"), condition: xe.describe("\u7ED3\u6784\u5316\u8FBE\u6210\u6761\u4EF6") }), B = i({ key: e().describe("\u68C0\u67E5\u9879\u952E"), isCompleted: r().describe("\u662F\u5426\u5DF2\u5B8C\u6210") }), Ce = c(["dm_intro", "character_intro", "player_input", "dm_eval_changes", "dm_narrate_changes", "failure_check", "goal_check", "ending_check", "character_response"]), ve = c(["idle", "dm_intro_ready", "dm_intro_running", "dm_intro_done", "character_intro_ready", "character_intro_running", "character_intro_done", "player_input_ready", "player_input_running", "player_input_done", "character_response_ready", "character_response_running", "character_response_done", "dm_eval_changes_ready", "dm_eval_changes_running", "dm_eval_changes_done", "dm_narrate_changes_ready", "dm_narrate_changes_running", "dm_narrate_changes_done", "failure_check_ready", "failure_check_running", "failure_check_done", "goal_check_ready", "goal_check_running", "goal_check_done", "ending_check_ready", "ending_check_running", "ending_check_done", "ended"]), $e = { idle: { label: "\u7A7A\u95F2", placeholder: "\u8BF7\u5148\u70B9\u51FB\u5F00\u59CB\u6216\u7EE7\u7EED...", inputEnabled: false }, dm_intro_ready: { label: "DM\u5F00\u573A\u767D\uFF08\u51C6\u5907\uFF09", placeholder: "\u8BF7\u7B49\u5F85 DM \u5F00\u573A\u767D...", inputEnabled: false }, dm_intro_running: { label: "DM\u5F00\u573A\u767D\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "DM \u6B63\u5728\u5F00\u573A\u767D...", inputEnabled: false }, dm_intro_done: { label: "DM\u5F00\u573A\u767D\uFF08\u5B8C\u6210\uFF09", placeholder: "DM \u5F00\u573A\u767D\u5B8C\u6210...", inputEnabled: false }, character_intro_ready: { label: "\u89D2\u8272\u5F00\u573A\u767D\uFF08\u51C6\u5907\uFF09", placeholder: "\u8BF7\u7B49\u5F85\u89D2\u8272\u5F00\u573A\u767D...", inputEnabled: false }, character_intro_running: { label: "\u89D2\u8272\u5F00\u573A\u767D\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u89D2\u8272\u6B63\u5728\u5F00\u573A\u767D...", inputEnabled: false }, character_intro_done: { label: "\u89D2\u8272\u5F00\u573A\u767D\uFF08\u5B8C\u6210\uFF09", placeholder: "\u89D2\u8272\u5F00\u573A\u767D\u5B8C\u6210...", inputEnabled: false }, player_input_ready: { label: "\u73A9\u5BB6\u8F93\u5165\uFF08\u51C6\u5907\uFF09", placeholder: "\u5728\u8FD9\u91CC\u4E66\u5199\u4F60\u7684\u4E0B\u4E00\u5E55...", inputEnabled: true }, player_input_running: { label: "\u73A9\u5BB6\u8F93\u5165\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u6B63\u5728\u63D0\u4EA4\u4F60\u7684\u8F93\u5165...", inputEnabled: false }, player_input_done: { label: "\u73A9\u5BB6\u8F93\u5165\uFF08\u5B8C\u6210\uFF09", placeholder: "\u8F93\u5165\u5DF2\u63D0\u4EA4...", inputEnabled: false }, character_response_ready: { label: "\u89D2\u8272\u56DE\u5E94\uFF08\u51C6\u5907\uFF09", placeholder: "\u8BF7\u7B49\u5F85\u89D2\u8272\u56DE\u5E94...", inputEnabled: false }, character_response_running: { label: "\u89D2\u8272\u56DE\u5E94\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u89D2\u8272\u6B63\u5728\u56DE\u5E94...", inputEnabled: false }, character_response_done: { label: "\u89D2\u8272\u56DE\u5E94\uFF08\u5B8C\u6210\uFF09", placeholder: "\u89D2\u8272\u56DE\u5E94\u5B8C\u6210...", inputEnabled: false }, dm_eval_changes_ready: { label: "DM\u8BC4\u4F30\uFF08\u51C6\u5907\uFF09", placeholder: "\u8BF7\u7B49\u5F85 DM \u8BC4\u4F30...", inputEnabled: false }, dm_eval_changes_running: { label: "DM\u8BC4\u4F30\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "DM \u6B63\u5728\u8BC4\u4F30...", inputEnabled: false }, dm_eval_changes_done: { label: "DM\u8BC4\u4F30\uFF08\u5B8C\u6210\uFF09", placeholder: "DM \u8BC4\u4F30\u5B8C\u6210...", inputEnabled: false }, dm_narrate_changes_ready: { label: "DM\u65C1\u767D\uFF08\u51C6\u5907\uFF09", placeholder: "\u8BF7\u7B49\u5F85 DM \u65C1\u767D...", inputEnabled: false }, dm_narrate_changes_running: { label: "DM\u65C1\u767D\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "DM \u6B63\u5728\u65C1\u767D...", inputEnabled: false }, dm_narrate_changes_done: { label: "DM\u65C1\u767D\uFF08\u5B8C\u6210\uFF09", placeholder: "DM \u65C1\u767D\u5B8C\u6210...", inputEnabled: false }, failure_check_ready: { label: "\u5931\u8D25\u68C0\u67E5\uFF08\u51C6\u5907\uFF09", placeholder: "\u51C6\u5907\u8FDB\u884C\u5931\u8D25\u68C0\u67E5...", inputEnabled: false }, failure_check_running: { label: "\u5931\u8D25\u68C0\u67E5\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u5931\u8D25\u68C0\u67E5\u8FDB\u884C\u4E2D...", inputEnabled: false }, failure_check_done: { label: "\u5931\u8D25\u68C0\u67E5\uFF08\u5B8C\u6210\uFF09", placeholder: "\u5931\u8D25\u68C0\u67E5\u5B8C\u6210...", inputEnabled: false }, goal_check_ready: { label: "\u76EE\u6807\u68C0\u67E5\uFF08\u51C6\u5907\uFF09", placeholder: "\u51C6\u5907\u8FDB\u884C\u76EE\u6807\u68C0\u67E5...", inputEnabled: false }, goal_check_running: { label: "\u76EE\u6807\u68C0\u67E5\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u76EE\u6807\u68C0\u67E5\u8FDB\u884C\u4E2D...", inputEnabled: false }, goal_check_done: { label: "\u76EE\u6807\u68C0\u67E5\uFF08\u5B8C\u6210\uFF09", placeholder: "\u76EE\u6807\u68C0\u67E5\u5B8C\u6210...", inputEnabled: false }, ending_check_ready: { label: "\u7ED3\u5C40\u68C0\u67E5\uFF08\u51C6\u5907\uFF09", placeholder: "\u51C6\u5907\u8FDB\u884C\u7ED3\u5C40\u68C0\u67E5...", inputEnabled: false }, ending_check_running: { label: "\u7ED3\u5C40\u68C0\u67E5\uFF08\u8FDB\u884C\u4E2D\uFF09", placeholder: "\u7ED3\u5C40\u68C0\u67E5\u8FDB\u884C\u4E2D...", inputEnabled: false }, ending_check_done: { label: "\u7ED3\u5C40\u68C0\u67E5\uFF08\u5B8C\u6210\uFF09", placeholder: "\u7ED3\u5C40\u68C0\u67E5\u5B8C\u6210...", inputEnabled: false }, ended: { label: "\u5DF2\u7ED3\u675F", placeholder: "\u6311\u6218\u5DF2\u7ED3\u675F", inputEnabled: false } }, U = i({ characterId: e().describe("\u8981\u6311\u6218\u7684\u89D2\u8272\u7684ID"), characterSnapshot: i({ name: e().describe("\u89D2\u8272\u540D\u79F0"), description: e().optional().describe("\u89D2\u8272\u63CF\u8FF0"), avatar: e().optional().describe("\u89D2\u8272\u5934\u50CF") }).optional().describe("\u89D2\u8272\u7684\u5FEB\u7167\u4FE1\u606F\uFF0C\u7528\u4E8E\u4FDD\u6301\u4F1A\u8BDD\u4E00\u81F4\u6027"), roleTaskPrompt: e().describe("\u89D2\u8272\u4EFB\u52A1\u63D0\u793A\u8BCD\uFF0C\u7528\u6765\u5F15\u5BFC\u89D2\u8272\u5728\u8BE5\u6311\u6218\u4E2D\u7684\u884C\u4E3A\u65B9\u5F0F"), userGuidance: e().describe("\u7528\u6237\u5F15\u5BFC\u8BED\uFF0C\u7528\u6765\u5F15\u5BFC\u7528\u6237\u5728\u8BE5\u6311\u6218\u4E2D\u7684\u884C\u4E3A"), variables: p(e(), j).describe("\u53D8\u91CF\u8BB0\u5F55"), goals: o(F.extend({ characterPrompt: e().describe("\u8FBE\u6210\u6B64\u76EE\u6807\u540E\uFF0C\u7ED9\u89D2\u8272\u589E\u52A0\u7684\u63D0\u793A\u8BCD"), userInfo: e().describe("\u8FBE\u6210\u6B64\u76EE\u6807\u540E\uFF0C\u7ED9\u7528\u6237\u7684\u63D0\u793A\u4FE1\u606F") })).describe("\u76EE\u6807\u5217\u8868"), failureChecks: o(F.extend({ characterPrompt: e().describe("\u89E6\u53D1\u6B64\u5931\u8D25\u540E\uFF0C\u7ED9\u89D2\u8272\u589E\u52A0\u7684\u63D0\u793A\u8BCD"), userInfo: e().describe("\u89E6\u53D1\u6B64\u5931\u8D25\u540E\uFF0C\u7ED9\u7528\u6237\u7684\u63D0\u793A\u4FE1\u606F") })).describe("\u5931\u8D25\u6761\u4EF6\u5217\u8868\uFF0C\u4E0E\u76EE\u6807\u540C\u6784\uFF0C\u7528\u6765\u68C0\u67E5\u6311\u6218\u662F\u5426\u5931\u8D25") }), De = i({ currentPhase: Ce.describe("\u5F53\u524D\u9636\u6BB5\u540D\u79F0"), currentUIState: ve.describe("\u5F53\u524D UI \u72B6\u6001\u540D\u79F0"), shouldCheck: r().default(true).describe("\u662F\u5426\u9700\u8981\u6267\u884C\u68C0\u67E5\u6D41\u7A0B"), variableStates: be.describe("\u6A21\u5F0F\u53D8\u91CF\u5B57\u5178"), goalStates: B.array().describe("\u76EE\u6807\u69FD\u4F4D\u6570\u7EC4"), failureStates: B.array().describe("\u5931\u8D25\u68C0\u67E5\u69FD\u4F4D\u6570\u7EC4") });
re.extend({ mode: n("challenge").describe("\u6A21\u5F0F"), modeConfig: U.describe("\u6311\u6218\u6A21\u5F0F\u914D\u7F6E"), modeState: De.describe("\u6311\u6218\u6A21\u5F0F\u72B6\u6001") });
const Ee = U.extend({ id: e().describe("\u6311\u6218\u5361ID"), name: e().describe("\u6311\u6218\u5361\u540D\u79F0"), description: e().describe("\u6311\u6218\u5361\u63CF\u8FF0"), tags: o(e()).optional().describe("\u6807\u7B7E\u6570\u7EC4"), createdAt: t().optional().describe("\u521B\u5EFA\u65F6\u95F4"), updatedAt: t().optional().describe("\u66F4\u65B0\u65F6\u95F4") }), Te = se, Me = Ee, ke = i({ id: e().describe("\u4F1A\u8BDDID"), title: e().optional().describe("\u4F1A\u8BDD\u6807\u9898"), contextId: e().optional().nullable().describe("\u5173\u8054\u7684\u4E0A\u4E0B\u6587\u7684ID"), mode: e().describe("\u6A21\u5F0F"), modeConfig: p(e(), _()).describe("\u6A21\u5F0F\u914D\u7F6E"), modeState: p(e(), _()).describe("\u6A21\u5F0F\u4E13\u7528\u72B6\u6001"), characterId: e().optional().describe("\u89D2\u8272ID"), challengeId: e().optional().describe("\u6311\u6218ID"), createdAt: t().describe("\u521B\u5EFA\u65F6\u95F4"), updatedAt: t().describe("\u66F4\u65B0\u65F6\u95F4"), isActive: r().optional().describe("\u662F\u5426\u6D3B\u8DC3") }), Ae = l, g = { MASTER_DB_NAME: "silly-tavern-master-db", SESSION_DB_PREFIX: "silly-tavern-session-" };
function we(a) {
  return typeof a == "object" && a !== null && W(a) !== void 0;
}
function x(a) {
  if (we(a)) return H(a);
  if (Array.isArray(a)) return a.map((s) => x(s));
  if (a && typeof a == "object") {
    const s = {};
    for (const [d, b] of Object.entries(a)) s[d] = x(b);
    return s;
  }
  return a;
}
function Ne(a) {
  const s = `${g.SESSION_DB_PREFIX}${a}`, d = new I(s);
  return d.version(2).stores({ contextItems: "id, type, timestamp, idx" }), { contextItems: y(v({ id: "contextItems", schema: Ae, getKey: (b) => b.id || "", dbName: s })), dexieInstance: d };
}
const C = /* @__PURE__ */ new Map(), $ = typeof BroadcastChannel < "u" ? new BroadcastChannel("silly-tavern-session-db") : null;
$ == null ? void 0 : $.addEventListener("message", (a) => {
  const s = a.data;
  (s == null ? void 0 : s.type) === "close" && s.sessionId && E(s.sessionId);
});
class Fe {
  constructor(s) {
    __publicField(this, "sessionId");
    __publicField(this, "database");
    this.sessionId = s, this.database = this.initDatabase();
  }
  initDatabase() {
    let s = C.get(this.sessionId);
    return s || (s = Ne(this.sessionId), C.set(this.sessionId, s)), s;
  }
  async getContextItems() {
    return (await this.database.contextItems.utils.getTable().toArray()).sort((b, f) => {
      const T = b.idx ?? 0, M = f.idx ?? 0;
      if (T !== M) return T - M;
      const k = b.orderRef ?? 0, A = f.orderRef ?? 0;
      if (k !== A) return k - A;
      const w = b.timestamp ?? 0, N = f.timestamp ?? 0;
      return w !== N ? w - N : (b.id || "").localeCompare(f.id || "");
    });
  }
  get contextItemsCollectionInstance() {
    return this.database.contextItems;
  }
  async addContextItem(s) {
    return await this.database.contextItems.utils.getTable().put(x(s));
  }
  async addContextItems(s) {
    return await this.database.contextItems.utils.getTable().bulkPut(x(s));
  }
  async deleteContextItem(s) {
    return await this.database.contextItems.utils.getTable().delete(s);
  }
  async clearContextItems() {
    return await this.database.contextItems.utils.getTable().clear();
  }
}
function E(a) {
  const s = `${g.SESSION_DB_PREFIX}${a}`, d = C.get(a);
  if (d) {
    try {
      d.dexieInstance.close();
    } catch (b) {
      console.warn(`Failed to close database ${s} before deletion:`, b);
    }
    C.delete(a);
  }
}
function q(a) {
  $ == null ? void 0 : $.postMessage({ type: "close", sessionId: a });
}
async function G(a) {
  const s = `${g.SESSION_DB_PREFIX}${a}`;
  q(a), E(a);
  try {
    await I.delete(s);
  } catch (d) {
    if (d instanceof Error && d.name === "DatabaseClosedError") {
      console.warn(`Database ${s} is still in use, retrying deletion...`), await new Promise((b) => setTimeout(b, 500));
      try {
        await I.delete(s);
      } catch (b) {
        throw console.error(`Failed to delete database ${s} after retry:`, b), b;
      }
    } else throw d;
  }
}
const qe = Object.freeze(Object.defineProperty({ __proto__: null, SessionDB: Fe, broadcastCloseSessionDatabase: q, closeSessionDatabase: E, deleteSessionDatabase: G }, Symbol.toStringTag, { value: "Module" })), Be = new I(g.MASTER_DB_NAME);
Be.version(1).stores({ characters: "id, name, creator, createdAt, updatedAt", challenges: "id, name, createdAt, updatedAt", sessions: "id, characterId, challengeId, mode, updatedAt" });
const K = y(v({ id: "characters", schema: Te, getKey: (a) => a.id, dbName: g.MASTER_DB_NAME })), S = y(v({ id: "challenges", schema: Me, getKey: (a) => a.id, dbName: g.MASTER_DB_NAME })), X = y(v({ id: "sessions", schema: ke, getKey: (a) => a.id, dbName: g.MASTER_DB_NAME })), m = { characters: { getTable: () => K.utils.getTable(), add: async (a) => (await m.characters.getTable()).add(a), put: async (a) => (await m.characters.getTable()).put(a), delete: async (a) => (await m.characters.getTable()).delete(a) }, challenges: { getTable: () => S.utils.getTable(), add: async (a) => (await m.challenges.getTable()).add(a), put: async (a) => (await m.challenges.getTable()).put(a), delete: async (a) => (await m.challenges.getTable()).delete(a), find: async (a) => (await m.challenges.getTable()).get(a), findLive: (a) => y(z({ id: `find-challenge-${a || "none"}`, startSync: true, query: (s) => a ? s.from({ challenge: S }).where(({ challenge: d }) => J(d.id, a)).select(({ challenge: d }) => d) : s.from({ challenge: S }).where(() => false) })) }, sessions: { getTable: () => X.utils.getTable(), add: async (a) => (await m.sessions.getTable()).add(a), put: async (a) => (await m.sessions.getTable()).put(a), update: async (a, s) => (await m.sessions.getTable()).update(a, s), delete: async (a) => {
  await (await m.sessions.getTable()).delete(a), await G(a);
} } }, Ge = Object.freeze(Object.defineProperty({ __proto__: null, ChallengesCollection: S, CharactersCollection: K, SessionsMetadataCollection: X, masterDb: m }, Symbol.toStringTag, { value: "Module" }));
export {
  K as C,
  pe as O,
  se as P,
  X as S,
  S as a,
  Ee as b,
  Le as c,
  V as d,
  je as e,
  E as f,
  Fe as g,
  l as h,
  Ue as i,
  me as j,
  _e as k,
  he as l,
  m,
  D as n,
  L as o,
  Ie as p,
  $e as q,
  re as r,
  qe as s,
  Ge as t
};
